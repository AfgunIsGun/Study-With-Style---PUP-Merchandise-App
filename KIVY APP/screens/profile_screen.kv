from kivy.app import App
from kivy.uix.screenmanager import Screen
from kivy.properties import StringProperty
from database import DatabaseManager

class ProfileScreen(Screen):
    username = StringProperty('')
    db_manager = DatabaseManager()

    def on_pre_enter(self, *args):
        app = App.get_running_app()
        self.username = getattr(app, 'current_user', '')
        profile = self.db_manager.fetch_profile(self.username)
        if profile:
            self.ids.name_label.text = f"Name: {profile['name'] or 'Not set'}"
            self.ids.address1_label.text = profile['address1'] or 'Not set'
            self.ids.contact1_label.text = f"Contact: {profile['contact1'] or 'Not set'}"
            self.ids.address2_label.text = profile['address2'] or 'Not set'
            self.ids.contact2_label.text = f"Contact: {profile['contact2'] or 'Not set'}"
        else:
            self.ids.name_label.text = "Name: Not set"
            self.ids.address1_label.text = 'Not set'
            self.ids.contact1_label.text = 'Contact: Not set'
            self.ids.address2_label.text = 'Not set'
            self.ids.contact2_label.text = 'Contact: Not set'
            
    def logout(self):
        app = App.get_running_app()
        app.current_user = None
        app.cart = []
        self.manager.current = 'login'